# OperatingSystem - Lab2

##  Алокатор пам'яті загального призначення (реалізація на основі сторінок)
#### Опис алгоритму

Даний код емулює логіку роботи алокатора пам'яті загального призначеня.
Пам'ять, якою оперує алокатор поділена на сторінки. У прикладі алокатору виділено 4кБ пам'яті, розмір однієї сторінки - 256 Б, тобто уся виділена пам'ять розбита на 16 сторінок. Кожна сторінка може перебувати в одному із трьох станів: Free, DividedIntoBlocks, MultiPageBlock.

- **Free** - сторінка на даний момент вільна
- **DividedIntoBlocks** - сторінка розбита на блоки однакового розміру. У випадку якщо розмір пам'яті, яку потрібно виділити менший або рівний половині сторінки, виділяється блок відповідного класу. Класи можуть мати розмір **2^x, де ( 2^3 <= x <= PAGE_SIZE / 2)**. Вказівники на сторінки кожного класу зберігаються в асоціативному масиві **map <int, vector<void\*>> classifiedPages**.
- **MultiPageBlock** - блок пам'яті займає одну або декілька сторінок. У випадку якщо розмір пам'яті, яку потрібно виділити більший половини сторінки, виділяється необхідна кількість сторінок.

Інформація про кожну сторінку зберігається у асоціативному масиві **map <void\*, PageHeader> pageHeaders**

#### Структура PageHeader
#
```
struct PageHeader 
{
	PageState state;
	size_t classSize;
	size_t blocksAmount;
	uint8_t* freeBlockPtr;
};
```

- **state** - стан, в якому перебуває сторінка.
- **classSize** - розмір блоків класу (якщо сторінка перебуває в стані DividedIntoBlocks), загальний розмір блоку (якщо сторінка перебуває в стані MultiPageBlock).
- **blocksAmount** - кількість вільних блоків класу на даній сторінці (якщо сторінка перебуває в стані DividedIntoBlocks), кількість сторінок, що йдуть після даної (якщо сторінка перебуває в стані MultiPageBlock).
- **freeBlockPtr** - вказівник на вільний блок (якщо сторінка перебуває в стані DividedIntoBlocks), вказівник на наступну сторінку блоку (якщо сторінка перебуває в стані MultiPageBlock).
#

Окрім цього у векторі **freePages** зберігаються вказівники на вільні сторінки.

- ##### **void\* mem_alloc(size_t)**

    Дана функція виділяє новий блок та повертає вказівник на нього. Якщо розмір блоку менший або рівний половині сторінки, то вираховується розмір класу. Якщо в асоціативному масиві немає вказівників на сторінки відповідного класу, тоді на блоки розбивається вільна сторінка і виділяється пам'ять для блоку. Якщо в асоціативному масиві є вказівники на сторінки даного класу, то виділяється пам'ять для блоку на одній із цих сторінок.

- ##### **void\* mem_realloc(void\*, size_t)**

    Дана функція змінює розмір блоку та повертає вказівник на блок або сторінку.
    
- ##### **void mem_free(void\*)**

    Функція приймає адресу пам'яті та звільняє блок або сторінку пам'яті з відповідною адресою.
    
- ##### **void mem_dump()**

    Виводить на консоль інформацію про стан сторінок пам'яті.
    
#

#### Приклад роботи

##### Код: 

```
Allocator alloc;	
alloc.mem_dump();
```

##### Вивід: 


![Screenshot1](https://github.com/Wistony/OperatingSystem_Labs/blob/master/Lab2_PageMemoryAllocator/img/1.png)

На даний момент уся пам'ять доступна, тому усі 16 сторінок вільні.

#

##### Код:

```
int* num = (int*)alloc.mem_alloc(20);
int* num1 = (int*)alloc.mem_alloc(30);
int* num2 = (int*)alloc.mem_alloc(97);
int* num3 = (int*)alloc.mem_alloc(110);
alloc.mem_dump();
```

##### Вивід: 

![Screenshot2](https://github.com/Wistony/OperatingSystem_Labs/blob/master/Lab2_PageMemoryAllocator/img/2.png)

Виділимо блок пам'яті розміром 20, 30, 97, 110. У перших двох випадках блок поміститься у клас розміром 32 байти, у третьому та четвертому випадку блок поміститься у клас розміром 128 байтів. Оскільки перед цим уся пам'ять була вільна, спочатку вільна сторінка поділиться на блоки розміром 32 байти і 2 блоки буде виділено(адреси блоків зберігаються у вказівниках num та num1). Аналогічна ситуація із блоками розміром 128, оскільки сторінки даного класу перед викликом mem_alloc() не було, спочатку вільна сторінка розіб'ється на блоки по 128, а потім буде виділено 2 блоки (вказівники num2 і num3).

#

##### Код:

```
int* num4 = (int*)alloc.mem_alloc(514);
alloc.mem_dump();
```

##### Вивід: 

![Screenshot3](https://github.com/Wistony/OperatingSystem_Labs/blob/master/Lab2_PageMemoryAllocator/img/3.png)

Виділимо блок пам'яті розміром 514 байт. Для цього потрібно виділити 3 сторінки.

#

##### Код:

```
alloc.mem_realloc(num4, 200);
alloc.mem_realloc(num1, 60);
alloc.mem_dump();
```

##### Вивід: 

![Screenshot4](https://github.com/Wistony/OperatingSystem_Labs/blob/master/Lab2_PageMemoryAllocator/img/4.png)

Змінюємо розмір багатосторінкового блоку, тепер замість 3 сторінок він займає 1. Змінюємо розмір блоку з адресою num1 до 60 байтів. Блок перейде із класу 32 до класу 64. Перед цим для даного класу буде виділена вільна сторінка.

#

##### Код:

```
alloc.mem_free(num);
alloc.mem_free(num2);
alloc.mem_free(num4);
alloc.mem_dump();
```

##### Вивід: 

![Screenshot5](https://github.com/Wistony/OperatingSystem_Labs/blob/master/Lab2_PageMemoryAllocator/img/5.png)

Звільнимо блок із класу в 32 байти. Оскільки всі блоки в даному класі після цього стануть вільні, то сторінка перейде в стан Free. Далі звільнимо один з блоків класу 128, бачимо, що один блок став вільним. Також звільнимо блок, розмір якого перед цим було зменшено з 3 сторінок до 1.
